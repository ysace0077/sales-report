<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACE & ESSA SALES REPORT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.3em;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom: 4px solid #ffc107;
        }
        
        .tab:hover:not(.active) {
            background: #f0f0f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            color: #333;
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-change {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .positive {
            background: #e6f7ee;
            color: #00a854;
        }
        
        .negative {
            background: #fdeeee;
            color: #f5222d;
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: 400px;
            width: 100%;
            overflow: hidden;
        }
        
        .chart-title {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .chart-container {
            height: 320px;
            position: relative;
            width: 100%;
        }
        
        .chart-container canvas {
            max-width: 100%;
            height: auto !important;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .filter-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            font-size: 0.95em;
        }
        
        select {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            color: #333;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #43e97b;
            color: white;
        }
        
        .btn-success:hover {
            background: #2fd467;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }
        
        .data-source-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }
        
        .monthly-trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .ace-frame-chart {
            display: none;
        }
        
        .essa-chart {
            display: none;
        }
        
        .ace-bed-size-charts {
            display: none;
        }
        
        /* íƒœë¸”ë¦¿ */
        @media (max-width: 1200px) {
            .container {
                padding: 0 10px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .subtitle {
                font-size: 1.1em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                width: 100%;
            }
            
            .monthly-trends-grid {
                grid-template-columns: 1fr;
                width: 100%;
            }
            
            .chart-card {
                width: 100%;
                max-width: 100%;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-controls {
                justify-content: center;
            }
            
            .button-group {
                justify-content: center;
            }
        }
        
        /* ëª¨ë°”ì¼ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                overflow-x: hidden;
            }
            
            .container {
                width: 100%;
                max-width: 100%;
                padding: 0;
                overflow-x: hidden;
            }
            
            header {
                padding: 20px 15px;
                margin-bottom: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 0.95em;
            }
            
            .tab-container {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .tab {
                padding: 15px 10px;
                font-size: 1em;
            }
            
            .data-source-info {
                padding: 12px;
                font-size: 0.9em;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .filter-section {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .filter-container {
                width: 100%;
                max-width: 100%;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                width: 100%;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .filter-label {
                font-size: 0.9em;
            }
            
            select {
                width: 100%;
                min-width: auto;
                padding: 12px 15px;
                font-size: 1em;
            }
            
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            
            button {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 100%;
            }
            
            .stat-card {
                padding: 20px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .stat-icon {
                font-size: 2em;
            }
            
            .stat-value {
                font-size: 1.6em;
            }
            
            .stat-change {
                position: static;
                display: inline-block;
                margin-top: 10px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 100%;
            }
            
            .monthly-trends-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 100%;
            }
            
            .chart-card {
                padding: 15px;
                height: 350px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .chart-title {
                font-size: 1.1em;
                margin-bottom: 15px;
            }
            
            .chart-container {
                height: 280px;
                width: 100%;
                max-width: 100%;
            }
            
            .chart-container canvas {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .loading {
                padding: 30px 15px;
                font-size: 1.2em;
            }
            
            #dropZone {
                padding: 40px 20px !important;
            }
            
            #dropZone h2 {
                font-size: 1.3em !important;
            }
            
            #dropZone p {
                font-size: 1em !important;
            }
        }
        
        /* ì‘ì€ ëª¨ë°”ì¼ */
        @media (max-width: 480px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }
            
            .container {
                width: 100%;
                max-width: 100vw;
                padding: 0;
            }
            
            header {
                padding: 15px 10px;
                border-radius: 10px;
                width: 100%;
                box-sizing: border-box;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .subtitle {
                font-size: 0.85em;
            }
            
            .tab {
                padding: 12px 8px;
                font-size: 0.9em;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-label {
                font-size: 0.8em;
            }
            
            .stat-value {
                font-size: 1.4em;
            }
            
            .chart-card {
                padding: 12px;
                height: 320px;
                width: 100%;
                max-width: 100%;
            }
            
            .chart-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .chart-container {
                height: 260px;
                width: 100%;
                max-width: 100%;
            }
            
            .chart-container canvas {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            button {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            
            select {
                padding: 10px 12px;
                font-size: 0.95em;
            }
        }
        
        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            .tab {
                padding: 18px 15px;
                -webkit-tap-highlight-color: transparent;
            }
            
            button {
                padding: 14px 20px;
                -webkit-tap-highlight-color: transparent;
            }
            
            select {
                padding: 14px 15px;
            }
            
            .stat-card:hover {
                transform: none;
            }
            
            .btn-primary:hover,
            .btn-secondary:hover,
            .btn-success:hover,
            .btn-danger:hover {
                transform: none;
            }
            
            .tab:active {
                opacity: 0.8;
            }
            
            button:active {
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ACE & ESSA SALES REPORT</h1>
            <p class="subtitle">Year-over-Year Performance Analysis</p>
        </header>
        
        <div class="loading" id="loading">
            <div id="dropZone" style="border: 3px dashed white; padding: 60px; border-radius: 15px; cursor: pointer; background: rgba(255,255,255,0.1);">
                <h2 style="margin-bottom: 20px;">ğŸ“ SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h2>
                <p style="font-size: 1.1em;">sdata.db íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ì•„ì£¼ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3" style="display: none;">
            </div>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div class="tab-container">
                <div class="tab active" data-table="data_(ACE)">ACE íŒë§¤ ë°ì´í„°</div>
                <div class="tab" data-table="data_(ESSA)">ESSA íŒë§¤ ë°ì´í„°</div>
            </div>
            
            <div class="data-source-info" id="dataSourceInfo">í˜„ì¬ ë°ì´í„°: ACE íŒë§¤ ë°ì´í„°</div>
            
            <div class="filter-section">
                <div class="filter-container">
                    <div class="filter-controls">
                        <div class="filter-group">
                            <span class="filter-label">ë…„ë„:</span>
                            <select id="yearFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">ì›”:</span>
                            <select id="monthFilter">
                                <option value="">ì „ì²´</option>
                                <option value="1">1ì›”</option>
                                <option value="2">2ì›”</option>
                                <option value="3">3ì›”</option>
                                <option value="4">4ì›”</option>
                                <option value="5">5ì›”</option>
                                <option value="6">6ì›”</option>
                                <option value="7">7ì›”</option>
                                <option value="8">8ì›”</option>
                                <option value="9">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">íŒë§¤ì:</span>
                            <select id="sellerFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-primary" onclick="applyFilters()">í•„í„° ì ìš©</button>
                        <button class="btn-danger" onclick="resetFilters()">í•„í„° ì´ˆê¸°í™”</button>
                        <button class="btn-success" onclick="exportToExcel()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-label">ì´ ë§¤ì¶œ</div>
                    <div class="stat-value" id="totalSales">-</div>
                    <div class="stat-change" id="totalSalesChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ›’</div>
                    <div class="stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="stat-value" id="totalOrders">-</div>
                    <div class="stat-change" id="totalOrdersChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-label">ì´ íŒë§¤ ìˆ˜ëŸ‰</div>
                    <div class="stat-value" id="totalQuantity">-</div>
                    <div class="stat-change" id="totalQuantityChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-label">í‰ê·  ê±°ë˜ì•¡</div>
                    <div class="stat-value" id="avgSales">-</div>
                    <div class="stat-change" id="avgSalesChange">-</div>
                </div>
            </div>
            
            <div class="monthly-trends-grid">
                <div class="chart-card">
                    <h3 class="chart-title">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="monthlyOrdersChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">êµ¬ë§¤ìš©ë„ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="purposeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì‚¬ì´ì¦ˆë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="sizeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid essa-chart" id="ageCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="ageSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="essaSellerChartCard">
                    <h3 class="chart-title">íŒë§¤ìë³„ ë§¤ì¶œ ì‹¤ì </h3>
                    <div class="chart-container">
                        <canvas id="essaSellerChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid" id="regionCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì§€ì—­ë³„ íŒë§¤ ë¹„ì¤‘ (ì‹œ/êµ°/êµ¬ ê¸°ì¤€)</h3>
                    <div class="chart-container">
                        <canvas id="region2Chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì§€ì—­ë³„ íŒë§¤ ë¹„ì¤‘ (ì/ë©´/ë™ ê¸°ì¤€)</h3>
                    <div class="chart-container">
                        <canvas id="region3Chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-card" id="gradeChartCard">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="aceSellerChartCard">
                    <h3 class="chart-title">íŒë§¤ìë³„ ë§¤ì¶œ ì‹¤ì </h3>
                    <div class="chart-container">
                        <canvas id="aceSellerChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid ace-material-charts" id="aceMaterialCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ ë§¤ì¶œì•¡ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="aceMaterialSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="aceMaterialQuantityChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ACE ì „ìš©: ì¹¨ëŒ€ ì‚¬ì´ì¦ˆë³„ ë“±ê¸‰ íŒë§¤ìˆ˜ëŸ‰ ì°¨íŠ¸ -->
            <div class="charts-grid ace-bed-size-charts" id="bedSizeGradeCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ (1ì¸ìš©)</h3>
                    <div class="chart-container">
                        <canvas id="singleBedGradeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ (2ì¸ìš©)</h3>
                    <div class="chart-container">
                        <canvas id="doubleBedGradeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid essa-material-charts" id="essaMaterialCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì†Œì¬ë³„ ë§¤ì¶œì•¡ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="essaMaterialSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì†Œì¬ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="essaMaterialQuantityChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid ace-frame-chart" id="frameCharts">
                <div class="chart-card">
                    <h3 class="chart-title">í”„ë ˆì„ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="frameProductChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">í”„ë ˆì„ ìƒ‰ìƒë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="frameColorChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid essa-chart" id="productColorCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="productQuantityChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ìƒ‰ìƒë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="colorQuantityChart"></canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        let db;
        let charts = {};
        let SQL;
        let currentTable = "data_(ACE)";
        
        async function initSQL() {
            SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
            setupDropZone();
            setupTabs();
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTable = tab.getAttribute('data-table');
                    document.getElementById('dataSourceInfo').textContent = 
                        `í˜„ì¬ ë°ì´í„°: ${currentTable === 'data_(ACE)' ? 'ACE íŒë§¤ ë°ì´í„°' : 'ESSA íŒë§¤ ë°ì´í„°'}`;
                    updateUIForCurrentTab();
                    loadYearFilter();
                    loadSellerFilter();
                    loadDashboard();
                });
            });
        }
        
        function updateUIForCurrentTab() {
            const isEssaTab = currentTable === 'data_(ESSA)';
            const isAceTab = currentTable === 'data_(ACE)';
            
            document.getElementById('gradeChartCard').style.display = isEssaTab ? 'none' : 'block';
            document.getElementById('aceSellerChartCard').style.display = isEssaTab ? 'none' : 'block';
            document.getElementById('aceMaterialCharts').style.display = isAceTab ? 'grid' : 'none';
            document.getElementById('essaMaterialCharts').style.display = isEssaTab ? 'grid' : 'none';
            
            const aceFrameCharts = document.querySelectorAll('.ace-frame-chart');
            aceFrameCharts.forEach(chart => {
                chart.style.display = isAceTab ? 'grid' : 'none';
            });
            
            const essaCharts = document.querySelectorAll('.essa-chart');
            essaCharts.forEach(chart => {
                chart.style.display = isEssaTab ? 'grid' : 'none';
            });
            
            const aceBedSizeCharts = document.querySelectorAll('.ace-bed-size-charts');
            aceBedSizeCharts.forEach(chart => {
                chart.style.display = isAceTab ? 'grid' : 'none';
            });
        }
        
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.2)';
                dropZone.style.borderColor = '#43e97b';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.1)';
                dropZone.style.borderColor = 'white';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.1)';
                dropZone.style.borderColor = 'white';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        async function handleFile(file) {
            if (!file.name.endsWith('.db') && !file.name.endsWith('.sqlite') && !file.name.endsWith('.sqlite3')) {
                alert('SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼(.db, .sqlite, .sqlite3)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('dropZone').innerHTML = '<h2>ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”© ì¤‘... â³</h2>';
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const uInt8Array = new Uint8Array(e.target.result);
                        db = new SQL.Database(uInt8Array);
                        
                        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”:', tables);
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        
                        updateUIForCurrentTab();
                        loadYearFilter();
                        loadSellerFilter();
                        loadDashboard();
                    } catch (error) {
                        document.getElementById('dropZone').innerHTML = 
                            `<div class="error">ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>
                            <button onclick="location.reload()" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>`;
                        console.error('DB íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                document.getElementById('dropZone').innerHTML = 
                    `<div class="error">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${error.message}</div>
                    <button onclick="location.reload()" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>`;
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
            }
        }
        
        function loadYearFilter() {
            try {
                const stmt = db.prepare(`SELECT DISTINCT YEAR FROM "${currentTable}" ORDER BY YEAR DESC`);
                const years = [];
                while(stmt.step()) {
                    years.push(stmt.getAsObject());
                }
                stmt.free();
                
                const yearFilter = document.getElementById('yearFilter');
                yearFilter.innerHTML = '<option value="">ì „ì²´</option>';
                years.forEach(y => {
                    const option = document.createElement('option');
                    option.value = y.YEAR;
                    option.textContent = y.YEAR + 'ë…„';
                    yearFilter.appendChild(option);
                });
                
                if (years.length > 0) {
                    yearFilter.value = years[0].YEAR;
                }
            } catch (error) {
                console.error('ë…„ë„ í•„í„° ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function loadSellerFilter() {
            try {
                const stmt = db.prepare(`SELECT DISTINCT íŒë§¤ì FROM "${currentTable}" WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ORDER BY íŒë§¤ì`);
                const sellers = [];
                while(stmt.step()) {
                    sellers.push(stmt.getAsObject());
                }
                stmt.free();
                
                const sellerFilter = document.getElementById('sellerFilter');
                sellerFilter.innerHTML = '<option value="">ì „ì²´</option>';
                sellers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.íŒë§¤ì;
                    option.textContent = s.íŒë§¤ì;
                    sellerFilter.appendChild(option);
                });
            } catch (error) {
                console.error('íŒë§¤ì í•„í„° ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function applyFilters() {
            loadDashboard();
        }
        
        function resetFilters() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('sellerFilter').value = '';
            loadDashboard();
        }
        
        function getFilterCondition() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const seller = document.getElementById('sellerFilter').value;
            
            let condition = '';
            if (year) condition += ` AND YEAR = ${year}`;
            if (month) condition += ` AND MONTH = ${month}`;
            if (seller) condition += ` AND íŒë§¤ì = '${seller}'`;
            
            return condition;
        }
        
        function loadDashboard() {
            try {
                const filter = getFilterCondition();
                const currentYear = document.getElementById('yearFilter').value;
                const prevYear = currentYear ? parseInt(currentYear) - 1 : null;
                
                const currentStatsQuery = `
                    SELECT 
                        SUM(ê±´ìˆ˜) as totalOrders,
                        SUM(í• ì¸ê°€) as totalSales,
                        SUM(ìˆ˜ëŸ‰) as totalQuantity
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                `;
                
                const currentStatsResult = db.exec(currentStatsQuery);
                if (currentStatsResult.length === 0) {
                    console.log('í˜„ì¬ë…„ë„ í†µê³„ ë°ì´í„° ì—†ìŒ');
                    return;
                }
                
                const currentStats = currentStatsResult[0].values[0];
                const currentAvgSales = currentStats[0] > 0 ? currentStats[1] / currentStats[0] : 0;
                
                let prevStats = [0, 0, 0];
                let prevAvgSales = 0;
                
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevStatsQuery = `
                        SELECT 
                            SUM(ê±´ìˆ˜) as totalOrders,
                            SUM(í• ì¸ê°€) as totalSales,
                            SUM(ìˆ˜ëŸ‰) as totalQuantity
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                    `;
                    const prevStatsResult = db.exec(prevStatsQuery);
                    if (prevStatsResult.length > 0) {
                        prevStats = prevStatsResult[0].values[0];
                        prevAvgSales = prevStats[0] > 0 ? prevStats[1] / prevStats[0] : 0;
                    }
                }
                
                const calcChange = (current, previous) => {
                    if (previous === 0) return 0;
                    return ((current - previous) / previous) * 100;
                };
                
                const salesChange = calcChange(currentStats[1], prevStats[1]);
                const ordersChange = calcChange(currentStats[0], prevStats[0]);
                const quantityChange = calcChange(currentStats[2], prevStats[2]);
                const avgSalesChange = calcChange(currentAvgSales, prevAvgSales);
                
                document.getElementById('totalOrders').textContent = Math.round(currentStats[0]).toLocaleString() + 'ê±´';
                document.getElementById('totalSales').textContent = 'â‚©' + Math.round(currentStats[1]).toLocaleString();
                document.getElementById('totalQuantity').textContent = Math.round(currentStats[2]).toLocaleString() + 'ê°œ';
                document.getElementById('avgSales').textContent = 'â‚©' + Math.round(currentAvgSales).toLocaleString();
                
                updateChangeIndicator('totalSalesChange', salesChange);
                updateChangeIndicator('totalOrdersChange', ordersChange);
                updateChangeIndicator('totalQuantityChange', quantityChange);
                updateChangeIndicator('avgSalesChange', avgSalesChange);
                
                loadMonthlySalesChart(filter, prevYear);
                loadMonthlyOrdersChart(filter, prevYear);
                loadPurposeChart(filter, prevYear);
                loadSizeChart(filter, prevYear);
                loadRegion2Chart(filter, prevYear);
                loadRegion3Chart(filter, prevYear);
                
                if (currentTable === 'data_(ACE)') {
                    loadGradeChart(filter, prevYear);
                    loadAceSellerChart(filter, prevYear);
                    loadAceMaterialDetailCharts(filter, prevYear);
                    loadFrameAnalysisCharts(filter, prevYear);
                    loadBedSizeGradeCharts(filter, prevYear);
                } else {
                    loadAgeCharts(filter, prevYear);
                    loadEssaSellerChart(filter, prevYear);
                    loadEssaMaterialDetailCharts(filter, prevYear);
                    loadProductColorCharts(filter, prevYear);
                }
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            if (change === 0) {
                element.textContent = '0%';
                element.className = 'stat-change';
            } else {
                const isPositive = change > 0;
                element.textContent = (isPositive ? '+' : '') + change.toFixed(1) + '%';
                element.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
            }
        }
        
        function loadMonthlySalesChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT MONTH, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                    GROUP BY MONTH
                    ORDER BY MONTH
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT MONTH, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                        GROUP BY MONTH
                        ORDER BY MONTH
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                const currentData = Array(12).fill(0);
                const prevData = Array(12).fill(0);
                
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            currentData[month-1] = row[1];
                        }
                    });
                }
                
                if (prevResult.values) {
                    prevResult.values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            prevData[month-1] = row[1];
                        }
                    });
                }
                
                if (charts.monthlySales) charts.monthlySales.destroy();
                const ctx = document.getElementById('monthlySalesChart').getContext('2d');
                charts.monthlySales = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderColor: '#ff6384',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadMonthlyOrdersChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT MONTH, SUM(ê±´ìˆ˜) as orders
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                    GROUP BY MONTH
                    ORDER BY MONTH
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT MONTH, SUM(ê±´ìˆ˜) as orders
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                        GROUP BY MONTH
                        ORDER BY MONTH
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                const currentData = Array(12).fill(0);
                const prevData = Array(12).fill(0);
                
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            currentData[month-1] = row[1];
                        }
                    });
                }
                
                if (prevResult.values) {
                    prevResult.values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            prevData[month-1] = row[1];
                        }
                    });
                }
                
                if (charts.monthlyOrders) charts.monthlyOrders.destroy();
                const ctx = document.getElementById('monthlyOrdersChart').getContext('2d');
                charts.monthlyOrders = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderColor: '#36a2eb',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderColor: '#4bc0c0',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => value.toLocaleString() + 'ê±´' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadPurposeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT êµ¬ë§¤ìš©ë„, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE êµ¬ë§¤ìš©ë„ IS NOT NULL AND êµ¬ë§¤ìš©ë„ != '' ${filter}
                    GROUP BY êµ¬ë§¤ìš©ë„
                    ORDER BY sales DESC
                    LIMIT 8
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT êµ¬ë§¤ìš©ë„, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE êµ¬ë§¤ìš©ë„ IS NOT NULL AND êµ¬ë§¤ìš©ë„ != '' ${prevFilter}
                        GROUP BY êµ¬ë§¤ìš©ë„
                        ORDER BY sales DESC
                        LIMIT 8
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.purpose) charts.purpose.destroy();
                const ctx = document.getElementById('purposeChart').getContext('2d');
                charts.purpose = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: '#ff6384',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('êµ¬ë§¤ìš©ë„ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadSizeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ê·œê²©, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ê·œê²© IS NOT NULL AND ê·œê²© != '' ${filter}
                    GROUP BY ê·œê²©
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ê·œê²©, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ê·œê²© IS NOT NULL AND ê·œê²© != '' ${prevFilter}
                        GROUP BY ê·œê²©
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.size) charts.size.destroy();
                const ctx = document.getElementById('sizeChart').getContext('2d');
                charts.size = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: '#ffc107',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: '#2196f3',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì‚¬ì´ì¦ˆ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadRegion2Chart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì§€ì—­2, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì§€ì—­2 IS NOT NULL AND ì§€ì—­2 != '' ${filter}
                    GROUP BY ì§€ì—­2
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì§€ì—­2, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì§€ì—­2 IS NOT NULL AND ì§€ì—­2 != '' ${prevFilter}
                        GROUP BY ì§€ì—­2
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.region2) charts.region2.destroy();
                const ctx = document.getElementById('region2Chart').getContext('2d');
                charts.region2 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(67, 233, 123, 0.7)',
                            borderColor: '#43e97b',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: '#ffc107',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì§€ì—­2 ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadRegion3Chart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì§€ì—­3, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì§€ì—­3 IS NOT NULL AND ì§€ì—­3 != '' ${filter}
                    GROUP BY ì§€ì—­3
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì§€ì—­3, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì§€ì—­3 IS NOT NULL AND ì§€ì—­3 != '' ${prevFilter}
                        GROUP BY ì§€ì—­3
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.region3) charts.region3.destroy();
                const ctx = document.getElementById('region3Chart').getContext('2d');
                charts.region3 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(156, 39, 176, 0.7)',
                            borderColor: '#9c27b0',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: '#2196f3',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì§€ì—­3 ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadGradeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT grade, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE grade IS NOT NULL AND grade != '' ${filter}
                    GROUP BY grade
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT grade, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE grade IS NOT NULL AND grade != '' ${prevFilter}
                        GROUP BY grade
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.grade) charts.grade.destroy();
                const ctx = document.getElementById('gradeChart').getContext('2d');
                charts.grade = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(250, 112, 154, 0.7)',
                            borderColor: '#fa709a',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(118, 75, 162, 0.7)',
                            borderColor: '#764ba2',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ë“±ê¸‰ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadAceSellerChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${filter}
                    GROUP BY íŒë§¤ì
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${prevFilter}
                        GROUP BY íŒë§¤ì
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.aceSeller) charts.aceSeller.destroy();
                const ctx = document.getElementById('aceSellerChart').getContext('2d');
                charts.aceSeller = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: '#2196f3',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ACE íŒë§¤ì ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadAceMaterialDetailCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ë“±ê¸‰,
                           SUM(í• ì¸ê°€) as sales,
                           SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${filter}
                    GROUP BY ë“±ê¸‰
                    ORDER BY sales DESC
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ë“±ê¸‰,
                               SUM(í• ì¸ê°€) as sales,
                               SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${prevFilter}
                        GROUP BY ë“±ê¸‰
                        ORDER BY sales DESC
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const currentQuantity = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[2] : 0;
                });
                
                const prevSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                const prevQuantity = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[2] : 0;
                });
                
                if (charts.aceMaterialSales) charts.aceMaterialSales.destroy();
                const salesCtx = document.getElementById('aceMaterialSalesChart').getContext('2d');
                charts.aceMaterialSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevSales,
                            backgroundColor: 'rgba(118, 75, 162, 0.7)',
                            borderColor: '#764ba2',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentSales,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
                
                if (charts.aceMaterialQuantity) charts.aceMaterialQuantity.destroy();
                const quantityCtx = document.getElementById('aceMaterialQuantityChart').getContext('2d');
                charts.aceMaterialQuantity = new Chart(quantityCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevQuantity,
                            backgroundColor: 'rgba(250, 112, 154, 0.7)',
                            borderColor: '#fa709a',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentQuantity,
                            backgroundColor: 'rgba(67, 233, 123, 0.7)',
                            borderColor: '#43e97b',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('ACE ë“±ê¸‰ ìƒì„¸ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ACE ì „ìš©: ì¹¨ëŒ€ ì‚¬ì´ì¦ˆë³„ ë“±ê¸‰ íŒë§¤ìˆ˜ëŸ‰ ì°¨íŠ¸
        function loadBedSizeGradeCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                // 1ì¸ìš© (SS, DS, DD)
                const singleBedFilter = `${filter} AND (ê·œê²© = 'SS' OR ê·œê²© = 'DS' OR ê·œê²© = 'DD')`;
                const singleBedQuery = `
                    SELECT ë“±ê¸‰, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${singleBedFilter}
                    GROUP BY ë“±ê¸‰
                    ORDER BY quantity DESC
                `;
                const singleBedResult = db.exec(singleBedQuery);
                
                let prevSingleBedResult = {values: []};
                if (prevYear) {
                    const prevSingleBedFilter = singleBedFilter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevSingleBedQuery = `
                        SELECT ë“±ê¸‰, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${prevSingleBedFilter}
                        GROUP BY ë“±ê¸‰
                        ORDER BY quantity DESC
                    `;
                    const prevSingleBedResultObj = db.exec(prevSingleBedQuery);
                    prevSingleBedResult = prevSingleBedResultObj.length > 0 ? prevSingleBedResultObj[0] : {values: []};
                }
                
                // 2ì¸ìš© (LQ, K3, LK)
                const doubleBedFilter = `${filter} AND (ê·œê²© = 'LQ' OR ê·œê²© = 'K3' OR ê·œê²© = 'LK')`;
                const doubleBedQuery = `
                    SELECT ë“±ê¸‰, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${doubleBedFilter}
                    GROUP BY ë“±ê¸‰
                    ORDER BY quantity DESC
                `;
                const doubleBedResult = db.exec(doubleBedQuery);
                
                let prevDoubleBedResult = {values: []};
                if (prevYear) {
                    const prevDoubleBedFilter = doubleBedFilter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevDoubleBedQuery = `
                        SELECT ë“±ê¸‰, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${prevDoubleBedFilter}
                        GROUP BY ë“±ê¸‰
                        ORDER BY quantity DESC
                    `;
                    const prevDoubleBedResultObj = db.exec(prevDoubleBedQuery);
                    prevDoubleBedResult = prevDoubleBedResultObj.length > 0 ? prevDoubleBedResultObj[0] : {values: []};
                }
                
                // 1ì¸ìš© ì°¨íŠ¸ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let singleAllLabels = new Set();
                if (singleBedResult.length > 0) {
                    singleBedResult[0].values.forEach(row => singleAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevSingleBedResult.values && prevSingleBedResult.values.length > 0) {
                    prevSingleBedResult.values.forEach(row => singleAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const singleLabels = singleAllLabels.size > 0 ? Array.from(singleAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const singleCurrentData = singleLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = singleBedResult.length > 0 ? singleBedResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const singlePrevData = singleLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevSingleBedResult.values ? prevSingleBedResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.singleBedGrade) charts.singleBedGrade.destroy();
                const singleCtx = document.getElementById('singleBedGradeChart').getContext('2d');
                    charts.singleBedGrade = new Chart(singleCtx, {
                        type: 'bar',
                        data: {
                            labels: singleLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: singlePrevData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: '#36a2eb',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: singleCurrentData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true },
                                title: {
                                    display: true,
                                    text: 'SS, DS, DD ê·œê²©'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
                
                // 2ì¸ìš© ì°¨íŠ¸ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let doubleAllLabels = new Set();
                if (doubleBedResult.length > 0) {
                    doubleBedResult[0].values.forEach(row => doubleAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevDoubleBedResult.values && prevDoubleBedResult.values.length > 0) {
                    prevDoubleBedResult.values.forEach(row => doubleAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const doubleLabels = doubleAllLabels.size > 0 ? Array.from(doubleAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const doubleCurrentData = doubleLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = doubleBedResult.length > 0 ? doubleBedResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const doublePrevData = doubleLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevDoubleBedResult.values ? prevDoubleBedResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.doubleBedGrade) charts.doubleBedGrade.destroy();
                const doubleCtx = document.getElementById('doubleBedGradeChart').getContext('2d');
                    charts.doubleBedGrade = new Chart(doubleCtx, {
                        type: 'bar',
                        data: {
                            labels: doubleLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: doublePrevData,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: '#4bc0c0',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: doubleCurrentData,
                                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                borderColor: '#9966ff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true },
                                title: {
                                    display: true,
                                    text: 'LQ, K3, LK ê·œê²©'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
            } catch (error) {
                console.error('ì¹¨ëŒ€ ì‚¬ì´ì¦ˆë³„ ë“±ê¸‰ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadFrameAnalysisCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const frameFilter = `${filter} AND ë¶„ë¥˜2 = 'í”„ë ˆì„'`;
                
                const currentProductQuery = `
                    SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${frameFilter}
                    GROUP BY ìƒí’ˆëª…
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const currentProductResult = db.exec(currentProductQuery);
                
                const currentColorQuery = `
                    SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${frameFilter}
                    GROUP BY ìƒ‰ìƒ
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const currentColorResult = db.exec(currentColorQuery);
                
                let prevProductResult = {values: []};
                let prevColorResult = {values: []};
                
                if (prevYear) {
                    const prevFrameFilter = frameFilter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    
                    const prevProductQuery = `
                        SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${prevFrameFilter}
                        GROUP BY ìƒí’ˆëª…
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevProductResultObj = db.exec(prevProductQuery);
                    prevProductResult = prevProductResultObj.length > 0 ? prevProductResultObj[0] : {values: []};
                    
                    const prevColorQuery = `
                        SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${prevFrameFilter}
                        GROUP BY ìƒ‰ìƒ
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevColorResultObj = db.exec(prevColorQuery);
                    prevColorResult = prevColorResultObj.length > 0 ? prevColorResultObj[0] : {values: []};
                }
                
                // í”„ë ˆì„ ìƒí’ˆ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let productAllLabels = new Set();
                if (currentProductResult.length > 0) {
                    currentProductResult[0].values.forEach(row => productAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevProductResult.values && prevProductResult.values.length > 0) {
                    prevProductResult.values.forEach(row => productAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const productLabels = productAllLabels.size > 0 ? Array.from(productAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentProductData = productLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentProductResult.length > 0 ? currentProductResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevProductData = productLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevProductResult.values ? prevProductResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.frameProduct) charts.frameProduct.destroy();
                const productCtx = document.getElementById('frameProductChart').getContext('2d');
                    charts.frameProduct = new Chart(productCtx, {
                        type: 'bar',
                        data: {
                            labels: productLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: prevProductData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: '#36a2eb',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: currentProductData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
                
                // í”„ë ˆì„ ìƒ‰ìƒ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let colorAllLabels = new Set();
                if (currentColorResult.length > 0) {
                    currentColorResult[0].values.forEach(row => colorAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevColorResult.values && prevColorResult.values.length > 0) {
                    prevColorResult.values.forEach(row => colorAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const colorLabels = colorAllLabels.size > 0 ? Array.from(colorAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentColorData = colorLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentColorResult.length > 0 ? currentColorResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevColorData = colorLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevColorResult.values ? prevColorResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.frameColor) charts.frameColor.destroy();
                const colorCtx = document.getElementById('frameColorChart').getContext('2d');
                    charts.frameColor = new Chart(colorCtx, {
                        type: 'bar',
                        data: {
                            labels: colorLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: prevColorData,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: '#4bc0c0',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: currentColorData,
                                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                borderColor: '#9966ff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
            } catch (error) {
                console.error('í”„ë ˆì„ ë¶„ì„ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadEssaSellerChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${filter}
                    GROUP BY íŒë§¤ì
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${prevFilter}
                        GROUP BY íŒë§¤ì
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevData = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.essaSeller) charts.essaSeller.destroy();
                const ctx = document.getElementById('essaSellerChart').getContext('2d');
                charts.essaSeller = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevData,
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: '#2196f3',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentData,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ESSA íŒë§¤ì ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadEssaMaterialDetailCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì†Œì¬,
                           SUM(í• ì¸ê°€) as sales,
                           SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ì†Œì¬ IS NOT NULL AND ì†Œì¬ != '' ${filter}
                    GROUP BY ì†Œì¬
                    ORDER BY sales DESC
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì†Œì¬,
                               SUM(í• ì¸ê°€) as sales,
                               SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ì†Œì¬ IS NOT NULL AND ì†Œì¬ != '' ${prevFilter}
                        GROUP BY ì†Œì¬
                        ORDER BY sales DESC
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const currentQuantity = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[2] : 0;
                });
                
                const prevSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                const prevQuantity = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[2] : 0;
                });
                
                if (charts.essaMaterialSales) charts.essaMaterialSales.destroy();
                const salesCtx = document.getElementById('essaMaterialSalesChart').getContext('2d');
                charts.essaMaterialSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevSales,
                            backgroundColor: 'rgba(118, 75, 162, 0.7)',
                            borderColor: '#764ba2',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentSales,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
                
                if (charts.essaMaterialQuantity) charts.essaMaterialQuantity.destroy();
                const quantityCtx = document.getElementById('essaMaterialQuantityChart').getContext('2d');
                charts.essaMaterialQuantity = new Chart(quantityCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevQuantity,
                            backgroundColor: 'rgba(250, 112, 154, 0.7)',
                            borderColor: '#fa709a',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentQuantity,
                            backgroundColor: 'rgba(67, 233, 123, 0.7)',
                            borderColor: '#43e97b',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('ESSA ì†Œì¬ ìƒì„¸ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadAgeCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì—°ë ¹ëŒ€, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì—°ë ¹ëŒ€ IS NOT NULL AND ì—°ë ¹ëŒ€ != '' ${filter}
                    GROUP BY ì—°ë ¹ëŒ€
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì—°ë ¹ëŒ€, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì—°ë ¹ëŒ€ IS NOT NULL AND ì—°ë ¹ëŒ€ != '' ${prevFilter}
                        GROUP BY ì—°ë ¹ëŒ€
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                // í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì³ì„œ ë¼ë²¨ ìƒì„±
                let allLabels = new Set();
                if (currentResult.length > 0) {
                    currentResult[0].values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevResult.values && prevResult.values.length > 0) {
                    prevResult.values.forEach(row => allLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const labels = allLabels.size > 0 ? Array.from(allLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const currentSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = currentResult.length > 0 ? currentResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const prevSales = labels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.ageSales) charts.ageSales.destroy();
                const salesCtx = document.getElementById('ageSalesChart').getContext('2d');
                charts.ageSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${prevYearShort}ë…„`,
                            data: prevSales,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: '#ff6384',
                            borderWidth: 1
                        }, {
                            label: `${currentYearShort}ë…„`,
                            data: currentSales,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: '#36a2eb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function loadProductColorCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const productQuery = `
                    SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${filter}
                    GROUP BY ìƒí’ˆëª…
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const productResult = db.exec(productQuery);
                
                const colorQuery = `
                    SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${filter}
                    GROUP BY ìƒ‰ìƒ
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const colorResult = db.exec(colorQuery);
                
                let prevProductResult = {values: []};
                let prevColorResult = {values: []};
                
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    
                    const prevProductQuery = `
                        SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${prevFilter}
                        GROUP BY ìƒí’ˆëª…
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevProductResultObj = db.exec(prevProductQuery);
                    prevProductResult = prevProductResultObj.length > 0 ? prevProductResultObj[0] : {values: []};
                    
                    const prevColorQuery = `
                        SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${prevFilter}
                        GROUP BY ìƒ‰ìƒ
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevColorResultObj = db.exec(prevColorQuery);
                    prevColorResult = prevColorResultObj.length > 0 ? prevColorResultObj[0] : {values: []};
                }
                
                // ìƒí’ˆ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let productAllLabels = new Set();
                if (productResult.length > 0) {
                    productResult[0].values.forEach(row => productAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevProductResult.values && prevProductResult.values.length > 0) {
                    prevProductResult.values.forEach(row => productAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const productLabels = productAllLabels.size > 0 ? Array.from(productAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const productCurrentQuantity = productLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = productResult.length > 0 ? productResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const productPrevQuantity = productLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevProductResult.values ? prevProductResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.productQuantity) charts.productQuantity.destroy();
                const productQuantityCtx = document.getElementById('productQuantityChart').getContext('2d');
                    charts.productQuantity = new Chart(productQuantityCtx, {
                        type: 'bar',
                        data: {
                            labels: productLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: productPrevQuantity,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: productCurrentQuantity,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: '#36a2eb',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                
                // ìƒ‰ìƒ - í˜„ì¬ë…„ë„ì™€ ì „ë…„ë„ ë°ì´í„° ëª¨ë‘ í•©ì¹˜ê¸°
                let colorAllLabels = new Set();
                if (colorResult.length > 0) {
                    colorResult[0].values.forEach(row => colorAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                if (prevColorResult.values && prevColorResult.values.length > 0) {
                    prevColorResult.values.forEach(row => colorAllLabels.add(row[0] || 'ê¸°íƒ€'));
                }
                
                const colorLabels = colorAllLabels.size > 0 ? Array.from(colorAllLabels) : ['ë°ì´í„° ì—†ìŒ'];
                const colorCurrentQuantity = colorLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const currentRow = colorResult.length > 0 ? colorResult[0].values.find(row => row[0] === label) : null;
                    return currentRow ? currentRow[1] : 0;
                });
                const colorPrevQuantity = colorLabels.map(label => {
                    if (label === 'ë°ì´í„° ì—†ìŒ') return 0;
                    const prevRow = prevColorResult.values ? prevColorResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.colorQuantity) charts.colorQuantity.destroy();
                const colorQuantityCtx = document.getElementById('colorQuantityChart').getContext('2d');
                    charts.colorQuantity = new Chart(colorQuantityCtx, {
                        type: 'bar',
                        data: {
                            labels: colorLabels,
                            datasets: [{
                                label: `${prevYearShort}ë…„`,
                                data: colorPrevQuantity,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: '#36a2eb',
                                borderWidth: 1
                            }, {
                                label: `${currentYearShort}ë…„`,
                                data: colorCurrentQuantity,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: '#4bc0c0',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
            } catch (error) {
                console.error('ìƒí’ˆ/ìƒ‰ìƒ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        function exportToExcel() {
            try {
                const filter = getFilterCondition();
                const query = `SELECT * FROM "${currentTable}" WHERE 1=1 ${filter}`;
                const result = db.exec(query);
                
                if (result.length === 0) {
                    alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const columns = result[0].columns;
                const data = result[0].values;
                
                const wsData = [columns];
                data.forEach(row => wsData.push(row));
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'SalesData');
                
                const tableName = currentTable === 'data_(ACE)' ? 'ACE' : 'ESSA';
                const fileName = `${tableName}_Sales_Data_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        initSQL();
    </script>
</body>
</html>
