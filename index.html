<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACE & ESSA SALES REPORT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.3em;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom: 4px solid #ffc107;
        }
        
        .tab:hover:not(.active) {
            background: #f0f0f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            color: #333;
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-change {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .positive {
            background: #e6f7ee;
            color: #00a854;
        }
        
        .negative {
            background: #fdeeee;
            color: #f5222d;
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: 400px;
        }
        
        .chart-title {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .chart-container {
            height: 320px;
            position: relative;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        select, input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin: 5px;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #5568d3;
        }

        .data-source-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        /* ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .monthly-trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* ACE ì „ìš© í”„ë ˆì„ ë¶„ì„ ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        .ace-frame-chart {
            display: none;
        }

        /* ESSA ì „ìš© ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        .essa-chart {
            display: none;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            min-width: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ACE & ESSA SALES REPORT</h1>
            <p class="subtitle">Year-over-Year Performance Analysis</p>
        </header>
        
        <div class="loading" id="loading">
            <div id="dropZone" style="border: 3px dashed white; padding: 60px; border-radius: 15px; cursor: pointer; background: rgba(255,255,255,0.1);">
                <h2 style="margin-bottom: 20px;">ğŸ“ SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h2>
                <p style="font-size: 1.1em;">pdata.db íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ì•„ì£¼ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3" style="display: none;">
            </div>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div class="tab-container">
                <div class="tab active" data-table="data_(ACE)">ACE íŒë§¤ ë°ì´í„°</div>
                <div class="tab" data-table="data_(ESSA)">ESSA íŒë§¤ ë°ì´í„°</div>
            </div>
            
            <div class="data-source-info" id="dataSourceInfo">
                í˜„ì¬ ë°ì´í„°: ACE íŒë§¤ ë°ì´í„°
            </div>
            
            <div class="filter-section">
                <div class="filter-row">
                    <span class="filter-label">ë…„ë„:</span>
                    <select id="yearFilter">
                        <option value="">ì „ì²´</option>
                    </select>
                    
                    <span class="filter-label">ì›”:</span>
                    <select id="monthFilter">
                        <option value="">ì „ì²´</option>
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6">6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                    
                    <span class="filter-label">íŒë§¤ì:</span>
                    <select id="sellerFilter">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                
                <div class="filter-row">
                    <button onclick="applyFilters()">í•„í„° ì ìš©</button>
                    <button onclick="resetFilters()" style="background: #ff6b6b;">í•„í„° ì´ˆê¸°í™”</button>
                    <button onclick="exportToExcel()" style="background: #43e97b;">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-label">ì´ ë§¤ì¶œ</div>
                    <div class="stat-value" id="totalSales">-</div>
                    <div class="stat-change" id="totalSalesChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ›’</div>
                    <div class="stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="stat-value" id="totalOrders">-</div>
                    <div class="stat-change" id="totalOrdersChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-label">ì´ íŒë§¤ ìˆ˜ëŸ‰</div>
                    <div class="stat-value" id="totalQuantity">-</div>
                    <div class="stat-change" id="totalQuantityChange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-label">í‰ê·  ê±°ë˜ì•¡</div>
                    <div class="stat-value" id="avgSales">-</div>
                    <div class="stat-change" id="avgSalesChange">-</div>
                </div>
            </div>
            
            <!-- ì›”ë³„ ë§¤ì¶œ ì¶”ì´ì™€ ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì¶”ì´ë¥¼ ê°™ì€ ì¤„ì— í‘œì‹œ -->
            <div class="monthly-trends-grid">
                <div class="chart-card">
                    <h3 class="chart-title">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="monthlyOrdersChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- êµ¬ë§¤ìš©ë„ë³„ ë§¤ì¶œ ë¹„ì¤‘ê³¼ ì‚¬ì´ì¦ˆë³„ ë§¤ì¶œ ë¹„ì¤‘ - 2ê°œ ì°¨íŠ¸ í‘œì‹œ -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">êµ¬ë§¤ìš©ë„ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="purposeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì‚¬ì´ì¦ˆë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="sizeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ESSA ì „ìš©: ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¶„ì„ -->
            <div class="charts-grid essa-chart" id="ageCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="ageSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="essaSellerChartCard">
                    <h3 class="chart-title">íŒë§¤ìë³„ ë§¤ì¶œ ì‹¤ì </h3>
                    <div class="chart-container">
                        <canvas id="essaSellerChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ì§€ì—­ë³„ ì°¨íŠ¸ -->
            <div class="charts-grid" id="regionCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì§€ì—­ë³„ íŒë§¤ ë¹„ì¤‘ (ì‹œ/êµ°/êµ¬ ê¸°ì¤€)</h3>
                    <div class="chart-container">
                        <canvas id="region2Chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì§€ì—­ë³„ íŒë§¤ ë¹„ì¤‘ (ì/ë©´/ë™ ê¸°ì¤€)</h3>
                    <div class="chart-container">
                        <canvas id="region3Chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ë“±ê¸‰ ë° íŒë§¤ì ì°¨íŠ¸ -->
            <div class="charts-grid">
                <div class="chart-card" id="gradeChartCard">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ ë¹„ì¤‘</h3>
                    <div class="chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="aceSellerChartCard">
                    <h3 class="chart-title">íŒë§¤ìë³„ ë§¤ì¶œ ì‹¤ì </h3>
                    <div class="chart-container">
                        <canvas id="aceSellerChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ACE ì „ìš©: ë“±ê¸‰ë³„ ë§¤ì¶œì•¡/íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ -->
            <div class="charts-grid ace-material-charts" id="aceMaterialCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ ë§¤ì¶œì•¡ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="aceMaterialSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ë“±ê¸‰ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="aceMaterialQuantityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ESSA ì „ìš©: ì†Œì¬ë³„ ë§¤ì¶œì•¡/íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ -->
            <div class="charts-grid essa-material-charts" id="essaMaterialCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ì†Œì¬ë³„ ë§¤ì¶œì•¡ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="essaMaterialSalesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ì†Œì¬ë³„ íŒë§¤ìˆ˜ëŸ‰ ë¹„êµ</h3>
                    <div class="chart-container">
                        <canvas id="essaMaterialQuantityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ACE ì „ìš©: í”„ë ˆì„ ë¶„ì„ -->
            <div class="charts-grid ace-frame-chart" id="frameCharts">
                <div class="chart-card">
                    <h3 class="chart-title">í”„ë ˆì„ ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="frameProductChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">í”„ë ˆì„ ìƒ‰ìƒë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="frameColorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ESSA ì „ìš©: ìƒí’ˆ/ìƒ‰ìƒë³„ ë¶„ì„ -->
            <div class="charts-grid essa-chart" id="productColorCharts">
                <div class="chart-card">
                    <h3 class="chart-title">ìƒí’ˆë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="productQuantityChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">ìƒ‰ìƒë³„ íŒë§¤ìˆ˜ëŸ‰ ë¶„ì„</h3>
                    <div class="chart-container">
                        <canvas id="colorQuantityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let charts = {};
        let SQL;
        let currentTable = "data_(ACE)";
        
        // SQL.js ì´ˆê¸°í™”
        async function initSQL() {
            SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
            setupDropZone();
            setupTabs();
        }
        
        // íƒ­ ì„¤ì •
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                    tabs.forEach(t => t.classList.remove('active'));
                    // í´ë¦­í•œ íƒ­ í™œì„±í™”
                    tab.classList.add('active');
                    // í˜„ì¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    currentTable = tab.getAttribute('data-table');
                    // ë°ì´í„° ì†ŒìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
                    document.getElementById('dataSourceInfo').textContent = 
                        `í˜„ì¬ ë°ì´í„°: ${currentTable === 'data_(ACE)' ? 'ACE íŒë§¤ ë°ì´í„°' : 'ESSA íŒë§¤ ë°ì´í„°'}`;
                    
                    // íƒ­ë³„ UI ì—…ë°ì´íŠ¸
                    updateUIForCurrentTab();
                    
                    // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                    loadYearFilter();
                    loadSellerFilter();
                    loadDashboard();
                });
            });
        }
        
        // í˜„ì¬ íƒ­ì— ë§ê²Œ UI ì—…ë°ì´íŠ¸
        function updateUIForCurrentTab() {
            const isEssaTab = currentTable === 'data_(ESSA)';
            const isAceTab = currentTable === 'data_(ACE)';
            
            // ë“±ê¸‰ ì°¨íŠ¸ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('gradeChartCard').style.display = isEssaTab ? 'none' : 'block';
            
            // ACE íŒë§¤ì ì°¨íŠ¸ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('aceSellerChartCard').style.display = isEssaTab ? 'none' : 'block';
            
            // ACE/ESSA ì†Œì¬/ë“±ê¸‰ ì°¨íŠ¸ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('aceMaterialCharts').style.display = isAceTab ? 'grid' : 'none';
            document.getElementById('essaMaterialCharts').style.display = isEssaTab ? 'grid' : 'none';
            
            // ACE ì „ìš© í”„ë ˆì„ ì°¨íŠ¸ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            const aceFrameCharts = document.querySelectorAll('.ace-frame-chart');
            aceFrameCharts.forEach(chart => {
                chart.style.display = isAceTab ? 'grid' : 'none';
            });
            
            // ESSA ì „ìš© ì°¨íŠ¸ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            const essaCharts = document.querySelectorAll('.essa-chart');
            essaCharts.forEach(chart => {
                chart.style.display = isEssaTab ? 'grid' : 'none';
            });
        }
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // ë“œë˜ê·¸ ì˜¤ë²„
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.2)';
                dropZone.style.borderColor = '#43e97b';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.1)';
                dropZone.style.borderColor = 'white';
            });
            
            // ë“œë¡­
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.1)';
                dropZone.style.borderColor = 'white';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        // íŒŒì¼ ì²˜ë¦¬
        async function handleFile(file) {
            if (!file.name.endsWith('.db') && !file.name.endsWith('.sqlite') && !file.name.endsWith('.sqlite3')) {
                alert('SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼(.db, .sqlite, .sqlite3)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('dropZone').innerHTML = '<h2>ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”© ì¤‘... â³</h2>';
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const uInt8Array = new Uint8Array(e.target.result);
                        db = new SQL.Database(uInt8Array);
                        
                        // í…Œì´ë¸” í™•ì¸
                        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸”:', tables);
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        
                        // íƒ­ë³„ UI ì—…ë°ì´íŠ¸
                        updateUIForCurrentTab();
                        
                        loadYearFilter();
                        loadSellerFilter();
                        loadDashboard();
                    } catch (error) {
                        document.getElementById('dropZone').innerHTML = 
                            `<div class="error">ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>
                            <button onclick="location.reload()" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>`;
                        console.error('DB íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                document.getElementById('dropZone').innerHTML = 
                    `<div class="error">íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${error.message}</div>
                    <button onclick="location.reload()" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>`;
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
            }
        }
        
        function loadYearFilter() {
            try {
                const stmt = db.prepare(`SELECT DISTINCT YEAR FROM "${currentTable}" ORDER BY YEAR DESC`);
                const years = [];
                while(stmt.step()) {
                    years.push(stmt.getAsObject());
                }
                stmt.free();
                
                const yearFilter = document.getElementById('yearFilter');
                yearFilter.innerHTML = '<option value="">ì „ì²´</option>';
                years.forEach(y => {
                    const option = document.createElement('option');
                    option.value = y.YEAR;
                    option.textContent = y.YEAR + 'ë…„';
                    yearFilter.appendChild(option);
                });
                
                // ê¸°ë³¸ê°’ì„ ìµœì‹  ì—°ë„ë¡œ ì„¤ì •
                if (years.length > 0) {
                    yearFilter.value = years[0].YEAR;
                }
            } catch (error) {
                console.error('ë…„ë„ í•„í„° ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function loadSellerFilter() {
            try {
                const stmt = db.prepare(`SELECT DISTINCT íŒë§¤ì FROM "${currentTable}" WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ORDER BY íŒë§¤ì`);
                const sellers = [];
                while(stmt.step()) {
                    sellers.push(stmt.getAsObject());
                }
                stmt.free();
                
                const sellerFilter = document.getElementById('sellerFilter');
                sellerFilter.innerHTML = '<option value="">ì „ì²´</option>';
                sellers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.íŒë§¤ì;
                    option.textContent = s.íŒë§¤ì;
                    sellerFilter.appendChild(option);
                });
            } catch (error) {
                console.error('íŒë§¤ì í•„í„° ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function applyFilters() {
            loadDashboard();
        }
        
        function resetFilters() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('sellerFilter').value = '';
            loadDashboard();
        }
        
        function getFilterCondition() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const seller = document.getElementById('sellerFilter').value;
            let condition = '';
            
            if (year) condition += ` AND YEAR = ${year}`;
            if (month) condition += ` AND MONTH = ${month}`;
            if (seller) condition += ` AND íŒë§¤ì = '${seller}'`;
            
            return condition;
        }
        
        function loadDashboard() {
            try {
                const filter = getFilterCondition();
                const currentYear = document.getElementById('yearFilter').value;
                const prevYear = currentYear ? parseInt(currentYear) - 1 : null;
                
                // ì˜¬í•´ í†µê³„ ê³„ì‚°
                const currentStatsQuery = `
                    SELECT 
                        SUM(ê±´ìˆ˜) as totalOrders,
                        SUM(í• ì¸ê°€) as totalSales,
                        SUM(ìˆ˜ëŸ‰) as totalQuantity
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                `;
                const currentStatsResult = db.exec(currentStatsQuery);
                
                if (currentStatsResult.length === 0) {
                    console.log('í˜„ì¬ë…„ë„ í†µê³„ ë°ì´í„° ì—†ìŒ');
                    return;
                }
                
                const currentStats = currentStatsResult[0].values[0];
                const currentAvgSales = currentStats[0] > 0 ? currentStats[1] / currentStats[0] : 0;
                
                // ì‘ë…„ í†µê³„ ê³„ì‚°
                let prevStats = [0, 0, 0];
                let prevAvgSales = 0;
                
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevStatsQuery = `
                        SELECT 
                            SUM(ê±´ìˆ˜) as totalOrders,
                            SUM(í• ì¸ê°€) as totalSales,
                            SUM(ìˆ˜ëŸ‰) as totalQuantity
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                    `;
                    const prevStatsResult = db.exec(prevStatsQuery);
                    
                    if (prevStatsResult.length > 0) {
                        prevStats = prevStatsResult[0].values[0];
                        prevAvgSales = prevStats[0] > 0 ? prevStats[1] / prevStats[0] : 0;
                    }
                }
                
                // ë³€í™”ìœ¨ ê³„ì‚°
                const calcChange = (current, previous) => {
                    if (previous === 0) return 0;
                    return ((current - previous) / previous) * 100;
                };
                
                const salesChange = calcChange(currentStats[1], prevStats[1]);
                const ordersChange = calcChange(currentStats[0], prevStats[0]);
                const quantityChange = calcChange(currentStats[2], prevStats[2]);
                const avgSalesChange = calcChange(currentAvgSales, prevAvgSales);
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalOrders').textContent = Math.round(currentStats[0]).toLocaleString() + 'ê±´';
                document.getElementById('totalSales').textContent = 'â‚©' + Math.round(currentStats[1]).toLocaleString();
                document.getElementById('totalQuantity').textContent = Math.round(currentStats[2]).toLocaleString() + 'ê°œ';
                document.getElementById('avgSales').textContent = 'â‚©' + Math.round(currentAvgSales).toLocaleString();
                
                // ë³€í™”ìœ¨ í‘œì‹œ
                updateChangeIndicator('totalSalesChange', salesChange);
                updateChangeIndicator('totalOrdersChange', ordersChange);
                updateChangeIndicator('totalQuantityChange', quantityChange);
                updateChangeIndicator('avgSalesChange', avgSalesChange);
                
                // ëª¨ë“  ì°¨íŠ¸ ë¡œë“œ
                loadMonthlySalesChart(filter, prevYear);
                loadMonthlyOrdersChart(filter, prevYear);
                loadPurposeChart(filter, prevYear);
                loadSizeChart(filter, prevYear);
                loadRegion2Chart(filter, prevYear);
                loadRegion3Chart(filter, prevYear);
                
                // íƒ­ë³„ ì°¨íŠ¸ ë¡œë“œ
                if (currentTable === 'data_(ACE)') {
                    loadGradeChart(filter, prevYear);
                    loadAceSellerChart(filter, prevYear);
                    loadAceMaterialDetailCharts(filter, prevYear);
                    loadFrameAnalysisCharts(filter, prevYear);
                } else {
                    loadAgeCharts(filter, prevYear);
                    loadEssaSellerChart(filter, prevYear);
                    loadEssaMaterialDetailCharts(filter, prevYear);
                    loadProductColorCharts(filter, prevYear);
                }
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì˜¤ë¥˜:', error);
            }
        }
        
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            if (change === 0) {
                element.textContent = '0%';
                element.className = 'stat-change';
            } else {
                const isPositive = change > 0;
                element.textContent = (isPositive ? '+' : '') + change.toFixed(1) + '%';
                element.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
            }
        }
        
        // ì›”ë³„ ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
        function loadMonthlySalesChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT MONTH, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                    GROUP BY MONTH
                    ORDER BY MONTH
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT MONTH, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                        GROUP BY MONTH
                        ORDER BY MONTH
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const months = Array.from({length: 12}, (_, i) => i + 1);
                const currentData = Array(12).fill(0);
                const prevData = Array(12).fill(0);
                
                currentResult[0].values.forEach(row => {
                    const month = parseInt(row[0]);
                    if (month >= 1 && month <= 12) {
                        currentData[month-1] = row[1];
                    }
                });
                
                if (prevResult.values) {
                    prevResult.values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            prevData[month-1] = row[1];
                        }
                    });
                }
                
                if (charts.monthlySales) charts.monthlySales.destroy();
                
                const ctx = document.getElementById('monthlySalesChart').getContext('2d');
                charts.monthlySales = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderColor: '#667eea',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderColor: '#ff6384',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì¶”ì´ ì°¨íŠ¸
        function loadMonthlyOrdersChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT MONTH, SUM(ê±´ìˆ˜) as orders
                    FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                    GROUP BY MONTH
                    ORDER BY MONTH
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT MONTH, SUM(ê±´ìˆ˜) as orders
                        FROM "${currentTable}"
                        WHERE 1=1 ${prevFilter}
                        GROUP BY MONTH
                        ORDER BY MONTH
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const months = Array.from({length: 12}, (_, i) => i + 1);
                const currentData = Array(12).fill(0);
                const prevData = Array(12).fill(0);
                
                currentResult[0].values.forEach(row => {
                    const month = parseInt(row[0]);
                    if (month >= 1 && month <= 12) {
                        currentData[month-1] = row[1];
                    }
                });
                
                if (prevResult.values) {
                    prevResult.values.forEach(row => {
                        const month = parseInt(row[0]);
                        if (month >= 1 && month <= 12) {
                            prevData[month-1] = row[1];
                        }
                    });
                }
                
                if (charts.monthlyOrders) charts.monthlyOrders.destroy();
                
                const ctx = document.getElementById('monthlyOrdersChart').getContext('2d');
                charts.monthlyOrders = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderColor: '#36a2eb',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderColor: '#4bc0c0',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => value.toLocaleString() + 'ê±´' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì›”ë³„ íŒë§¤ ê±´ìˆ˜ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // êµ¬ë§¤ìš©ë„ë³„ ì°¨íŠ¸
        function loadPurposeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT êµ¬ë§¤ìš©ë„, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE êµ¬ë§¤ìš©ë„ IS NOT NULL AND êµ¬ë§¤ìš©ë„ != '' ${filter}
                    GROUP BY êµ¬ë§¤ìš©ë„
                    ORDER BY sales DESC
                    LIMIT 8
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT êµ¬ë§¤ìš©ë„, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE êµ¬ë§¤ìš©ë„ IS NOT NULL AND êµ¬ë§¤ìš©ë„ != '' ${prevFilter}
                        GROUP BY êµ¬ë§¤ìš©ë„
                        ORDER BY sales DESC
                        LIMIT 8
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.purpose) charts.purpose.destroy();
                
                const ctx = document.getElementById('purposeChart').getContext('2d');
                charts.purpose = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('êµ¬ë§¤ìš©ë„ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì‚¬ì´ì¦ˆë³„ ì°¨íŠ¸
        function loadSizeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ê·œê²©, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ê·œê²© IS NOT NULL AND ê·œê²© != '' ${filter}
                    GROUP BY ê·œê²©
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ê·œê²©, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ê·œê²© IS NOT NULL AND ê·œê²© != '' ${prevFilter}
                        GROUP BY ê·œê²©
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.size) charts.size.destroy();
                
                const ctx = document.getElementById('sizeChart').getContext('2d');
                charts.size = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(33, 150, 243, 0.7)',
                                borderColor: '#2196f3',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì‚¬ì´ì¦ˆ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì§€ì—­2 ì°¨íŠ¸
        function loadRegion2Chart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì§€ì—­2, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì§€ì—­2 IS NOT NULL AND ì§€ì—­2 != '' ${filter}
                    GROUP BY ì§€ì—­2
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì§€ì—­2, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì§€ì—­2 IS NOT NULL AND ì§€ì—­2 != '' ${prevFilter}
                        GROUP BY ì§€ì—­2
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.region2) charts.region2.destroy();
                
                const ctx = document.getElementById('region2Chart').getContext('2d');
                charts.region2 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(67, 233, 123, 0.7)',
                                borderColor: '#43e97b',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì§€ì—­2 ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì§€ì—­3 ì°¨íŠ¸
        function loadRegion3Chart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì§€ì—­3, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì§€ì—­3 IS NOT NULL AND ì§€ì—­3 != '' ${filter}
                    GROUP BY ì§€ì—­3
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì§€ì—­3, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì§€ì—­3 IS NOT NULL AND ì§€ì—­3 != '' ${prevFilter}
                        GROUP BY ì§€ì—­3
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.region3) charts.region3.destroy();
                
                const ctx = document.getElementById('region3Chart').getContext('2d');
                charts.region3 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(156, 39, 176, 0.7)',
                                borderColor: '#9c27b0',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(33, 150, 243, 0.7)',
                                borderColor: '#2196f3',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì§€ì—­3 ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ACE ë“±ê¸‰ë³„ ì°¨íŠ¸ (grade ì»¬ëŸ¼ ì‚¬ìš©)
        function loadGradeChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT grade, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE grade IS NOT NULL AND grade != '' ${filter}
                    GROUP BY grade
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT grade, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE grade IS NOT NULL AND grade != '' ${prevFilter}
                        GROUP BY grade
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.grade) charts.grade.destroy();
                
                const ctx = document.getElementById('gradeChart').getContext('2d');
                charts.grade = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(250, 112, 154, 0.7)',
                                borderColor: '#fa709a',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(118, 75, 162, 0.7)',
                                borderColor: '#764ba2',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ë“±ê¸‰ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ACE íŒë§¤ìë³„ ì°¨íŠ¸
        function loadAceSellerChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${filter}
                    GROUP BY íŒë§¤ì
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${prevFilter}
                        GROUP BY íŒë§¤ì
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.aceSeller) charts.aceSeller.destroy();
                
                const ctx = document.getElementById('aceSellerChart').getContext('2d');
                charts.aceSeller = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(33, 150, 243, 0.7)',
                                borderColor: '#2196f3',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(255, 152, 0, 0.7)',
                                borderColor: '#ff9800',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ACE íŒë§¤ì ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ESSA íŒë§¤ìë³„ ì°¨íŠ¸
        function loadEssaSellerChart(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${filter}
                    GROUP BY íŒë§¤ì
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT íŒë§¤ì, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE íŒë§¤ì IS NOT NULL AND íŒë§¤ì != '' ${prevFilter}
                        GROUP BY íŒë§¤ì
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentData = currentResult[0].values.map(row => row[1]);
                
                const prevData = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                if (charts.essaSeller) charts.essaSeller.destroy();
                
                const ctx = document.getElementById('essaSellerChart').getContext('2d');
                charts.essaSeller = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevData,
                                backgroundColor: 'rgba(33, 150, 243, 0.7)',
                                borderColor: '#2196f3',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentData,
                                backgroundColor: 'rgba(255, 152, 0, 0.7)',
                                borderColor: '#ff9800',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ESSA íŒë§¤ì ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ACE ë“±ê¸‰ ìƒì„¸ ì°¨íŠ¸ (ë“±ê¸‰ ì»¬ëŸ¼ ì‚¬ìš©)
        function loadAceMaterialDetailCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT 
                        ë“±ê¸‰,
                        SUM(í• ì¸ê°€) as sales,
                        SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${filter}
                    GROUP BY ë“±ê¸‰
                    ORDER BY sales DESC
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT 
                            ë“±ê¸‰,
                            SUM(í• ì¸ê°€) as sales,
                            SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ë“±ê¸‰ IS NOT NULL AND ë“±ê¸‰ != '' ${prevFilter}
                        GROUP BY ë“±ê¸‰
                        ORDER BY sales DESC
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentSales = currentResult[0].values.map(row => row[1]);
                const currentQuantity = currentResult[0].values.map(row => row[2]);
                
                const prevSales = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                const prevQuantity = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[2] : 0;
                });

                // ë§¤ì¶œì•¡ ì°¨íŠ¸
                if (charts.aceMaterialSales) charts.aceMaterialSales.destroy();
                const salesCtx = document.getElementById('aceMaterialSalesChart').getContext('2d');
                charts.aceMaterialSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevSales,
                                backgroundColor: 'rgba(118, 75, 162, 0.7)',
                                borderColor: '#764ba2',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentSales,
                                backgroundColor: 'rgba(255, 152, 0, 0.7)',
                                borderColor: '#ff9800',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });

                // íŒë§¤ìˆ˜ëŸ‰ ì°¨íŠ¸
                if (charts.aceMaterialQuantity) charts.aceMaterialQuantity.destroy();
                const quantityCtx = document.getElementById('aceMaterialQuantityChart').getContext('2d');
                charts.aceMaterialQuantity = new Chart(quantityCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevQuantity,
                                backgroundColor: 'rgba(250, 112, 154, 0.7)',
                                borderColor: '#fa709a',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentQuantity,
                                backgroundColor: 'rgba(67, 233, 123, 0.7)',
                                borderColor: '#43e97b',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('ACE ë“±ê¸‰ ìƒì„¸ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ESSA ì†Œì¬ ìƒì„¸ ì°¨íŠ¸
        function loadEssaMaterialDetailCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT 
                        ì†Œì¬,
                        SUM(í• ì¸ê°€) as sales,
                        SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ì†Œì¬ IS NOT NULL AND ì†Œì¬ != '' ${filter}
                    GROUP BY ì†Œì¬
                    ORDER BY sales DESC
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT 
                            ì†Œì¬,
                            SUM(í• ì¸ê°€) as sales,
                            SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ì†Œì¬ IS NOT NULL AND ì†Œì¬ != '' ${prevFilter}
                        GROUP BY ì†Œì¬
                        ORDER BY sales DESC
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentSales = currentResult[0].values.map(row => row[1]);
                const currentQuantity = currentResult[0].values.map(row => row[2]);
                
                const prevSales = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });
                
                const prevQuantity = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[2] : 0;
                });

                // ë§¤ì¶œì•¡ ì°¨íŠ¸
                if (charts.essaMaterialSales) charts.essaMaterialSales.destroy();
                const salesCtx = document.getElementById('essaMaterialSalesChart').getContext('2d');
                charts.essaMaterialSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevSales,
                                backgroundColor: 'rgba(118, 75, 162, 0.7)',
                                borderColor: '#764ba2',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentSales,
                                backgroundColor: 'rgba(255, 152, 0, 0.7)',
                                borderColor: '#ff9800',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });

                // íŒë§¤ìˆ˜ëŸ‰ ì°¨íŠ¸
                if (charts.essaMaterialQuantity) charts.essaMaterialQuantity.destroy();
                const quantityCtx = document.getElementById('essaMaterialQuantityChart').getContext('2d');
                charts.essaMaterialQuantity = new Chart(quantityCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevQuantity,
                                backgroundColor: 'rgba(250, 112, 154, 0.7)',
                                borderColor: '#fa709a',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentQuantity,
                                backgroundColor: 'rgba(67, 233, 123, 0.7)',
                                borderColor: '#43e97b',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('ESSA ì†Œì¬ ìƒì„¸ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ACE í”„ë ˆì„ ë¶„ì„ ì°¨íŠ¸
        function loadFrameAnalysisCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const frameFilter = ` AND ë¶„ë¥˜2 = 'í”„ë ˆì„' ${filter}`;
                
                // ìƒí’ˆë³„ ë°ì´í„°
                const currentProductQuery = `
                    SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${frameFilter}
                    GROUP BY ìƒí’ˆëª…
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const currentProductResult = db.exec(currentProductQuery);
                
                // ìƒ‰ìƒë³„ ë°ì´í„°
                const currentColorQuery = `
                    SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${frameFilter}
                    GROUP BY ìƒ‰ìƒ
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const currentColorResult = db.exec(currentColorQuery);
                
                let prevProductResult = {values: []};
                let prevColorResult = {values: []};
                
                if (prevYear) {
                    const prevFrameFilter = frameFilter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    
                    const prevProductQuery = `
                        SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${prevFrameFilter}
                        GROUP BY ìƒí’ˆëª…
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevProductResultObj = db.exec(prevProductQuery);
                    prevProductResult = prevProductResultObj.length > 0 ? prevProductResultObj[0] : {values: []};
                    
                    const prevColorQuery = `
                        SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${prevFrameFilter}
                        GROUP BY ìƒ‰ìƒ
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevColorResultObj = db.exec(prevColorQuery);
                    prevColorResult = prevColorResultObj.length > 0 ? prevColorResultObj[0] : {values: []};
                }
                
                // í”„ë ˆì„ ìƒí’ˆë³„ ì°¨íŠ¸
                if (currentProductResult.length > 0) {
                    const productLabels = currentProductResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                    const currentProductData = currentProductResult[0].values.map(row => row[1]);
                    
                    const prevProductData = productLabels.map(label => {
                        const prevRow = prevProductResult.values ? prevProductResult.values.find(row => row[0] === label) : null;
                        return prevRow ? prevRow[1] : 0;
                    });

                    if (charts.frameProduct) charts.frameProduct.destroy();
                    
                    const productCtx = document.getElementById('frameProductChart').getContext('2d');
                    charts.frameProduct = new Chart(productCtx, {
                        type: 'bar',
                        data: {
                            labels: productLabels,
                            datasets: [
                                {
                                    label: `${prevYearShort}ë…„`,
                                    data: prevProductData,
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: '#36a2eb',
                                    borderWidth: 1
                                },
                                {
                                    label: `${currentYearShort}ë…„`,
                                    data: currentProductData,
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    borderColor: '#ff6384',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
                }
                
                // í”„ë ˆì„ ìƒ‰ìƒë³„ ì°¨íŠ¸
                if (currentColorResult.length > 0) {
                    const colorLabels = currentColorResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                    const currentColorData = currentColorResult[0].values.map(row => row[1]);
                    
                    const prevColorData = colorLabels.map(label => {
                        const prevRow = prevColorResult.values ? prevColorResult.values.find(row => row[0] === label) : null;
                        return prevRow ? prevRow[1] : 0;
                    });

                    if (charts.frameColor) charts.frameColor.destroy();
                    
                    const colorCtx = document.getElementById('frameColorChart').getContext('2d');
                    charts.frameColor = new Chart(colorCtx, {
                        type: 'bar',
                        data: {
                            labels: colorLabels,
                            datasets: [
                                {
                                    label: `${prevYearShort}ë…„`,
                                    data: prevColorData,
                                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                    borderColor: '#4bc0c0',
                                    borderWidth: 1
                                },
                                {
                                    label: `${currentYearShort}ë…„`,
                                    data: currentColorData,
                                    backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                    borderColor: '#9966ff',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: value => value.toLocaleString() + 'ê°œ' }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('í”„ë ˆì„ ë¶„ì„ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ESSA ì—°ë ¹ëŒ€ë³„ ì°¨íŠ¸
        function loadAgeCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                const currentQuery = `
                    SELECT ì—°ë ¹ëŒ€, SUM(í• ì¸ê°€) as sales
                    FROM "${currentTable}"
                    WHERE ì—°ë ¹ëŒ€ IS NOT NULL AND ì—°ë ¹ëŒ€ != '' ${filter}
                    GROUP BY ì—°ë ¹ëŒ€
                    ORDER BY sales DESC
                    LIMIT 10
                `;
                const currentResult = db.exec(currentQuery);
                
                let prevResult = {values: []};
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    const prevQuery = `
                        SELECT ì—°ë ¹ëŒ€, SUM(í• ì¸ê°€) as sales
                        FROM "${currentTable}"
                        WHERE ì—°ë ¹ëŒ€ IS NOT NULL AND ì—°ë ¹ëŒ€ != '' ${prevFilter}
                        GROUP BY ì—°ë ¹ëŒ€
                        ORDER BY sales DESC
                        LIMIT 10
                    `;
                    const prevResultObj = db.exec(prevQuery);
                    prevResult = prevResultObj.length > 0 ? prevResultObj[0] : {values: []};
                }
                
                if (currentResult.length === 0) return;
                
                const labels = currentResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                const currentSales = currentResult[0].values.map(row => row[1]);
                
                const prevSales = labels.map(label => {
                    const prevRow = prevResult.values ? prevResult.values.find(row => row[0] === label) : null;
                    return prevRow ? prevRow[1] : 0;
                });

                if (charts.ageSales) charts.ageSales.destroy();
                const salesCtx = document.getElementById('ageSalesChart').getContext('2d');
                charts.ageSales = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${prevYearShort}ë…„`,
                                data: prevSales,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1
                            },
                            {
                                label: `${currentYearShort}ë…„`,
                                data: currentSales,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: '#36a2eb',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => 'â‚©' + (value/1000000).toFixed(1) + 'M' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ESSA ìƒí’ˆ/ìƒ‰ìƒë³„ ì°¨íŠ¸
        function loadProductColorCharts(filter, prevYear) {
            try {
                const currentYear = document.getElementById('yearFilter').value;
                const currentYearShort = currentYear ? currentYear.toString().slice(-2) : '24';
                const prevYearShort = prevYear ? prevYear.toString().slice(-2) : '23';
                
                // ìƒí’ˆë³„ ë°ì´í„°
                const productQuery = `
                    SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${filter}
                    GROUP BY ìƒí’ˆëª…
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const productResult = db.exec(productQuery);
                
                // ìƒ‰ìƒë³„ ë°ì´í„°
                const colorQuery = `
                    SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                    FROM "${currentTable}"
                    WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${filter}
                    GROUP BY ìƒ‰ìƒ
                    ORDER BY quantity DESC
                    LIMIT 10
                `;
                const colorResult = db.exec(colorQuery);
                
                let prevProductResult = {values: []};
                let prevColorResult = {values: []};
                
                if (prevYear) {
                    const prevFilter = filter.replace(`AND YEAR = ${currentYear}`, `AND YEAR = ${prevYear}`);
                    
                    const prevProductQuery = `
                        SELECT ìƒí’ˆëª…, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒí’ˆëª… IS NOT NULL AND ìƒí’ˆëª… != '' ${prevFilter}
                        GROUP BY ìƒí’ˆëª…
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevProductResultObj = db.exec(prevProductQuery);
                    prevProductResult = prevProductResultObj.length > 0 ? prevProductResultObj[0] : {values: []};
                    
                    const prevColorQuery = `
                        SELECT ìƒ‰ìƒ, SUM(ìˆ˜ëŸ‰) as quantity
                        FROM "${currentTable}"
                        WHERE ìƒ‰ìƒ IS NOT NULL AND ìƒ‰ìƒ != '' ${prevFilter}
                        GROUP BY ìƒ‰ìƒ
                        ORDER BY quantity DESC
                        LIMIT 10
                    `;
                    const prevColorResultObj = db.exec(prevColorQuery);
                    prevColorResult = prevColorResultObj.length > 0 ? prevColorResultObj[0] : {values: []};
                }
                
                // ìƒí’ˆë³„ ì°¨íŠ¸
                if (productResult.length > 0) {
                    const productLabels = productResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                    const productCurrentQuantity = productResult[0].values.map(row => row[1]);
                    
                    const productPrevQuantity = productLabels.map(label => {
                        const prevRow = prevProductResult.values ? prevProductResult.values.find(row => row[0] === label) : null;
                        return prevRow ? prevRow[1] : 0;
                    });

                    if (charts.productQuantity) charts.productQuantity.destroy();
                    const productQuantityCtx = document.getElementById('productQuantityChart').getContext('2d');
                    charts.productQuantity = new Chart(productQuantityCtx, {
                        type: 'bar',
                        data: {
                            labels: productLabels,
                            datasets: [
                                {
                                    label: `${prevYearShort}ë…„`,
                                    data: productPrevQuantity,
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    borderColor: '#ff6384',
                                    borderWidth: 1
                                },
                                {
                                    label: `${currentYearShort}ë…„`,
                                    data: productCurrentQuantity,
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: '#36a2eb',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
                
                // ìƒ‰ìƒë³„ ì°¨íŠ¸
                if (colorResult.length > 0) {
                    const colorLabels = colorResult[0].values.map(row => row[0] || 'ê¸°íƒ€');
                    const colorCurrentQuantity = colorResult[0].values.map(row => row[1]);
                    
                    const colorPrevQuantity = colorLabels.map(label => {
                        const prevRow = prevColorResult.values ? prevColorResult.values.find(row => row[0] === label) : null;
                        return prevRow ? prevRow[1] : 0;
                    });

                    if (charts.colorQuantity) charts.colorQuantity.destroy();
                    const colorQuantityCtx = document.getElementById('colorQuantityChart').getContext('2d');
                    charts.colorQuantity = new Chart(colorQuantityCtx, {
                        type: 'bar',
                        data: {
                            labels: colorLabels,
                            datasets: [
                                {
                                    label: `${prevYearShort}ë…„`,
                                    data: colorPrevQuantity,
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: '#36a2eb',
                                    borderWidth: 1
                                },
                                {
                                    label: `${currentYearShort}ë…„`,
                                    data: colorCurrentQuantity,
                                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                    borderColor: '#4bc0c0',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ìƒí’ˆ/ìƒ‰ìƒ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        function exportToExcel() {
            try {
                const filter = getFilterCondition();
                const query = `
                    SELECT * FROM "${currentTable}"
                    WHERE 1=1 ${filter}
                `;
                const result = db.exec(query);
                
                if (result.length === 0) {
                    alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const columns = result[0].columns;
                const data = result[0].values;
                
                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const wsData = [columns];
                data.forEach(row => wsData.push(row));
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ì›Œí¬ë¶ ìƒì„± ë° ì‹œíŠ¸ ì¶”ê°€
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'SalesData');
                
                // íŒŒì¼ ì €ì¥
                const tableName = currentTable === 'data_(ACE)' ? 'ACE' : 'ESSA';
                const fileName = `${tableName}_Sales_Data_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì•± ì´ˆê¸°í™”
        initSQL();
    </script>
</body>
</html>